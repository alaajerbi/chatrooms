<!doctype html>
<html>
  <head>
    <title>Chatroom</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css">
    <style>
      * { box-sizing: border-box; }
      form { background: #000; padding: 3px 0; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
  </head>
  <body>
    <ul id="messages"></ul>
    <form action="">
      <input id="m" autocomplete="off" /><button class="send-message-btn" type="submit">Send</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/jquery/jquery.min.js"></script>
    <script type="text/javascript">
      var roomName = 'abcdef';
      var socket = io();
      socket.emit('create', roomName);

      socket.on('welcome', function(){
        var username = prompt('Choose a username (Or leave it blank to get the default one)');
        if (username && username.trim() != '') {
          socket.emit('change username', username);
        }

        socket.emit('ready');
      });

      var messageList = document.querySelector('#messages');
      var msgField = document.querySelector('#m');
      var btn = document.querySelector('.send-message-btn');

      function handleSubmit(e) {
          e.preventDefault();
          socket.emit('chat message', msgField.value);
          msgField.value = '';
          return false;
      }

      document.querySelector('form').addEventListener('submit', handleSubmit);


        socket.on('chat message', function(data){
          let messageElement = document.createElement('li');
          messageElement.innerHTML = '<b>' + data.username + '</b>: ' + data.message;
          messageList.appendChild(messageElement);
        });

        socket.on('ready', function(data) {
          let messageElement = document.createElement('li');
          messageElement.innerHTML = '<b>' + data.username + ' has joined the room</b>';
          messageList.appendChild(messageElement);

          if (data.numberOfClients < 2 ) {
             let messageElement = document.createElement('li');
             messageElement.innerHTML = 'Waiting for another client...';
              messageList.appendChild(messageElement);
              btn.disabled = true;
              msgField.disabled = true;
          }
          else {
            let messageElement = document.createElement('li');
            messageElement.innerHTML = 'Start!'
            messageList.appendChild(messageElement);
            btn.disabled = false;
            msgField.disabled = false;
          }
        });

        socket.on('client left', function(username) {
          let messageElement = document.createElement('li');
          messageElement.innerHTML = '<b>' + username + ' has left the chat.</b>';
          messageList.appendChild(messageElement);
          msgField.disabled = true;
          btn.disabled = true;
        });


        socket.on('room full', function(data) {
          socket.emit('end');
          let messageElement = document.createElement('li');
          messageElement.innerHTML = "<b>You can't join this room because it is already full.</b>";
          messageList.appendChild(messageElement);
          msgField.disabled = true;
          btn.disabled = true;
        });
      
    </script>
  </body>
</html>